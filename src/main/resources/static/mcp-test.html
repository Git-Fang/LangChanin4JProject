<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP SSE测试客户端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #5568d3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .log-container {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #667eea;
        }

        .log-entry.request {
            border-left-color: #4caf50;
        }

        .log-entry.response {
            border-left-color: #2196f3;
        }

        .log-entry.error {
            border-left-color: #f44336;
        }

        .log-entry .timestamp {
            color: #888;
            margin-right: 10px;
        }

        .log-entry .type {
            color: #667eea;
            margin-right: 10px;
            font-weight: bold;
        }

        .tools-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .tool-card {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .tool-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .tool-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-actions button {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Markdown内容样式 */
        .markdown-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .markdown-content h1 {
            font-size: 24px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .markdown-content h2 {
            font-size: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .markdown-content h3 {
            font-size: 18px;
        }

        .markdown-content h4 {
            font-size: 16px;
        }

        .markdown-content p {
            margin-bottom: 15px;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 15px;
            padding-left: 30px;
        }

        .markdown-content li {
            margin-bottom: 5px;
        }

        .markdown-content code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            color: #e83e8c;
        }

        .markdown-content pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
            font-size: 13px;
        }

        .markdown-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
            background-color: #f8f9fa;
            padding: 10px 15px;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .markdown-content a {
            color: #667eea;
            text-decoration: none;
        }

        .markdown-content a:hover {
            text-decoration: underline;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .markdown-content hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MCP SSE测试客户端</h1>

        <!-- 连接配置 -->
        <div class="section">
            <h2>连接配置</h2>
            <div class="control-group">
                <label for="baseUrl">服务端点URL</label>
                <input type="url" id="baseUrl" value="http://localhost:8000/mcp" placeholder="http://localhost:8000/mcp">
            </div>
            <div class="control-group">
                <label for="sessionId">会话ID (留空自动生成)</label>
                <input type="text" id="sessionId" placeholder="自动生成">
            </div>
            <div class="control-group">
                <button id="connectBtn" onclick="connect()">建立SSE连接</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>断开连接</button>
            </div>
            <div id="connectionStatus" class="status disconnected">未连接</div>
        </div>

        <!-- 快速操作 -->
        <div class="section">
            <h2>快速操作</h2>
            <div class="quick-actions">
                <button onclick="quickInitialize()" id="quickInitBtn" disabled>初始化</button>
                <button onclick="quickToolsList()" id="quickToolsBtn" disabled>获取工具列表</button>
                <button onclick="quickShutdown()" id="quickShutdownBtn" disabled>关闭会话</button>
            </div>
        </div>

        <!-- 工具调用 -->
        <div class="section">
            <h2>工具调用</h2>
            <div class="control-group">
                <label for="toolName">工具名称</label>
                <select id="toolName" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <option value="">选择工具...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="toolArguments">工具参数 (JSON格式)</label>
                <textarea id="toolArguments"></textarea>
            </div>
            <div class="control-group">
                <button onclick="callTool()" id="callToolBtn" disabled>调用工具</button>
            </div>
            
            <!-- 工具调用结果 -->
            <div class="control-group" id="toolResultGroup" style="display: none;">
                <label>工具调用结果</label>
                <div id="toolResult" style="background: #f8f9fa; padding: 15px; border: 1px solid #e0e0e0; border-radius: 4px; max-height: 400px; overflow-y: auto;">
                    <div id="toolResultMarkdown" class="markdown-content"></div>
                </div>
            </div>
        </div>

        <!-- 自定义消息 -->
        <div class="section">
            <h2>自定义消息</h2>
            <div class="control-group">
                <label for="customMessage">自定义JSON-RPC消息</label>
                <textarea id="customMessage" placeholder='{"jsonrpc": "2.0", "id": "1", "method": "initialize", "params": {...}}'></textarea>
            </div>
            <div class="control-group">
                <button onclick="sendCustomMessage()" id="sendCustomBtn" disabled>发送消息</button>
            </div>
        </div>

        <!-- 工具列表 -->
        <div class="section">
            <h2>可用工具</h2>
            <div id="toolsList" class="tools-list">
                <p style="color: #999;">暂无工具，请先初始化并获取工具列表</p>
            </div>
        </div>

        <!-- 消息日志 -->
        <div class="section">
            <h2>消息日志</h2>
            <div class="control-group">
                <button onclick="clearLog()">清空日志</button>
            </div>
            <div id="logContainer" class="log-container">
                <div class="log-entry">
                    <span class="timestamp">--:--:--</span>
                    <span class="type">INFO</span>
                    <span class="message">日志已初始化</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Markdown渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let eventSource = null;
        let sessionId = null;
        let messageId = 1;
        let tools = [];

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'status ' + status;
            
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const quickInitBtn = document.getElementById('quickInitBtn');
            const quickToolsBtn = document.getElementById('quickToolsBtn');
            const quickShutdownBtn = document.getElementById('quickShutdownBtn');
            const callToolBtn = document.getElementById('callToolBtn');
            const sendCustomBtn = document.getElementById('sendCustomBtn');

            if (status === 'connected') {
                statusEl.textContent = '已连接';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                quickInitBtn.disabled = false;
                quickToolsBtn.disabled = false;
                quickShutdownBtn.disabled = false;
                callToolBtn.disabled = false;
                sendCustomBtn.disabled = false;
            } else {
                statusEl.textContent = '未连接';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                quickInitBtn.disabled = true;
                quickToolsBtn.disabled = true;
                quickShutdownBtn.disabled = true;
                callToolBtn.disabled = true;
                sendCustomBtn.disabled = true;
            }
        }

        function addLog(type, message, data = null) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type.toLowerCase();
            
            const now = new Date();
            const timestamp = now.toTimeString().split(' ')[0];
            
            let content = `<span class="timestamp">${timestamp}</span>`;
            content += `<span class="type">${type}</span>`;
            content += `<span class="message">${message}</span>`;
            
            if (data) {
                content += `<pre style="margin-top: 5px; padding: 5px; background-color: #1a1a1a; border-radius: 3px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            entry.innerHTML = content;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLog() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            addLog('INFO', '日志已清空');
        }

        function connect() {
            const baseUrl = document.getElementById('baseUrl').value;
            const inputSessionId = document.getElementById('sessionId').value;
            
            sessionId = inputSessionId || generateSessionId();
            document.getElementById('sessionId').value = sessionId;

            const sseUrl = `${baseUrl}/sse?sessionId=${sessionId}`;
            addLog('INFO', `正在连接SSE: ${sseUrl}`, { sessionId });

            eventSource = new EventSource(sseUrl);

            eventSource.onopen = () => {
                updateConnectionStatus('connected');
                addLog('INFO', 'SSE连接已建立');
            };

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addLog('RESPONSE', '收到SSE消息', data);
                    
                    // 处理工具列表响应
                    if (data.result && data.result.tools) {
                        tools = data.result.tools;
                        updateToolsList(tools);
                    }
                    
                    // 处理工具调用结果（通过检查result.content来判断）
                    if (data.result && data.result.content && Array.isArray(data.result.content)) {
                        displayToolResult(data.result);
                    }
                } catch (e) {
                    addLog('ERROR', '解析SSE消息失败: ' + e.message, event.data);
                }
            };

            eventSource.onerror = (error) => {
                updateConnectionStatus('disconnected');
                addLog('ERROR', 'SSE连接错误', error);
                disconnect();
            };
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateConnectionStatus('disconnected');
                addLog('INFO', 'SSE连接已关闭');
            }
        }

        async function sendMessage(message) {
            const baseUrl = document.getElementById('baseUrl').value;
            const messagesUrl = `${baseUrl}/messages`;

            addLog('REQUEST', '发送消息', message);

            try {
                const response = await fetch(messagesUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': sessionId
                    },
                    body: JSON.stringify(message)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.text();
                if (data) {
                    addLog('RESPONSE', '收到响应', JSON.parse(data));
                }
            } catch (error) {
                addLog('ERROR', '发送消息失败: ' + error.message);
            }
        }

        function quickInitialize() {
            const message = {
                jsonrpc: "2.0",
                id: String(messageId++),
                method: "initialize",
                params: {
                    protocolVersion: "2024-11-05",
                    capabilities: {},
                    clientInfo: {
                        name: "WebTestClient",
                        version: "1.0.0"
                    }
                }
            };
            sendMessage(message);
        }

        function quickToolsList() {
            const message = {
                jsonrpc: "2.0",
                id: String(messageId++),
                method: "tools/list"
            };
            sendMessage(message);
        }

        function quickShutdown() {
            const message = {
                jsonrpc: "2.0",
                id: String(messageId++),
                method: "shutdown"
            };
            sendMessage(message);
        }

        function callTool() {
            const toolName = document.getElementById('toolName').value;
            const argumentsText = document.getElementById('toolArguments').value;

            if (!toolName) {
                addLog('ERROR', '请选择工具');
                return;
            }

            let argumentsObj = {};
            try {
                if (argumentsText.trim()) {
                    argumentsObj = JSON.parse(argumentsText);
                }
            } catch (e) {
                addLog('ERROR', '参数JSON格式错误: ' + e.message);
                return;
            }

            const message = {
                jsonrpc: "2.0",
                id: String(messageId++),
                method: "tools/call",
                params: {
                    name: toolName,
                    arguments: argumentsObj
                }
            };
            sendMessage(message);
        }

        function sendCustomMessage() {
            const messageText = document.getElementById('customMessage').value;
            
            try {
                const message = JSON.parse(messageText);
                if (!message.id) {
                    message.id = String(messageId++);
                }
                sendMessage(message);
            } catch (e) {
                addLog('ERROR', '消息JSON格式错误: ' + e.message);
            }
        }

        function updateToolsList(toolsData) {
            const container = document.getElementById('toolsList');
            const select = document.getElementById('toolName');
            
            // 更新下拉列表
            select.innerHTML = '<option value="">选择工具...</option>';
            toolsData.forEach(tool => {
                const option = document.createElement('option');
                option.value = tool.name;
                option.textContent = tool.name;
                select.appendChild(option);
            });

            // 更新工具卡片
            container.innerHTML = '';
            toolsData.forEach(tool => {
                const card = document.createElement('div');
                card.className = 'tool-card';
                
                // 生成参数模板
                let paramTemplate = '{}';
                if (tool.inputSchema && tool.inputSchema.properties) {
                    const properties = tool.inputSchema.properties;
                    const required = tool.inputSchema.required || [];
                    const params = {};
                    
                    for (const [key, schema] of Object.entries(properties)) {
                        if (schema.type === 'string') {
                            params[key] = required.includes(key) ? '' : schema.description || '';
                        } else if (schema.type === 'number' || schema.type === 'integer') {
                            params[key] = required.includes(key) ? 0 : (schema.minimum || 0);
                        } else if (schema.type === 'boolean') {
                            params[key] = false;
                        } else if (schema.type === 'array') {
                            params[key] = [];
                        } else {
                            params[key] = null;
                        }
                    }
                    paramTemplate = JSON.stringify(params, null, 2);
                }
                
                // 存储参数模板到工具对象
                tool.paramTemplate = paramTemplate;
                
                card.innerHTML = `
                    <h3>${tool.name}</h3>
                    <p>${tool.description || '暂无描述'}</p>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        <strong>参数模板:</strong>
                        <pre style="background: #f5f5f5; padding: 8px; border-radius: 4px; overflow-x: auto;">${paramTemplate}</pre>
                    </div>
                `;
                container.appendChild(card);
            });

            addLog('INFO', `已更新工具列表，共 ${toolsData.length} 个工具`);
        }

        function displayToolResult(result) {
            const resultGroup = document.getElementById('toolResultGroup');
            const resultContainer = document.getElementById('toolResultMarkdown');
            
            resultGroup.style.display = 'block';
            
            // 格式化显示结果
            let resultText = '';
            if (typeof result === 'string') {
                resultText = result;
            } else if (result.content && Array.isArray(result.content)) {
                // 处理MCP标准响应格式
                resultText = result.content.map(item => {
                    if (item.type === 'text') {
                        return item.text;
                    } else if (item.type === 'image') {
                        return `[图片: ${item.data.substring(0, 50)}...]`;
                    }
                    return JSON.stringify(item);
                }).join('\n\n');
            } else {
                resultText = JSON.stringify(result, null, 2);
            }
            
            // 使用marked库渲染Markdown
            resultContainer.innerHTML = marked.parse(resultText);
            addLog('INFO', '工具调用结果已显示');
        }

        // 页面加载时初始化
        window.onload = function() {
            addLog('INFO', 'MCP SSE测试客户端已加载');
            
            // 监听工具选择变化，自动填充参数模板
            document.getElementById('toolName').addEventListener('change', function() {
                const selectedToolName = this.value;
                const selectedTool = tools.find(t => t.name === selectedToolName);
                
                if (selectedTool && selectedTool.paramTemplate) {
                    document.getElementById('toolArguments').value = selectedTool.paramTemplate;
                    addLog('INFO', `已加载工具 ${selectedToolName} 的参数模板`);
                }
            });
        };
    </script>
</body>
</html>
